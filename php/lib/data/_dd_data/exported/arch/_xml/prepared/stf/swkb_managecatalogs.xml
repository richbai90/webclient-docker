<?xml version="1.0" encoding="utf-8" ?>
<espForm>
	<configuration>
		<settings>
			<name>swkb_managecatalogs</name>
			<title>Manage KnowledgeBase Catalogs</title>
			<printTemplates>
			</printTemplates>
			<options>
				<allowResize>true</allowResize>
				<showMenubar>false</showMenubar>
				<showToolbar>false</showToolbar>
				<showStatusBar>false</showStatusBar>
			</options>
		</settings>
		<tables>
		</tables>
		<showMeItems>
		</showMeItems>
		<javascript>
			<methods>
			</methods>
		</javascript>
	</configuration>
	<layouts>
		<layout>
			<appearance>
				<width>355</width>
				<height>187</height>
				<backgroundColor>#eaeaea</backgroundColor>
				<fillColour>#ffffff</fillColour>
				<textColour >#000000</textColour >
				<font  size="8">Arial</font>
			</appearance>
			<controls>
				<control>
					<general>
						<name>SqlList1</name>
						<type>SqlTable</type>
						<flags>
							<transparent>false</transparent>
							<xpStyle>false</xpStyle>
							<hasShadow>false</hasShadow>
							<toolbarButtonStyle>false</toolbarButtonStyle>
							<cache>false</cache>
							<hasBorder>false</hasBorder>
							<hasCheckbox>false</hasCheckbox>
							<showHeader>true</showHeader>
							<verticalGridLines>false</verticalGridLines>
							<horizontalGridLines>false</horizontalGridLines>
							<autoLoad>true</autoLoad>
							<allowMultiSelect>false</allowMultiSelect>
						</flags>
					</general>
					<appearance>
						<index>0</index>
						<backgroundColor>#ffffff</backgroundColor>
						<foregroundColor>#000000</foregroundColor>
						<font  size="8">Arial</font>
						<borderStyle>Rectangle</borderStyle>
					</appearance>
					<objectPlacement>
						<position>
							<top>5</top>
							<left>5</left>
							<right>262</right>
							<bottom>186</bottom>
						</position>
						<scaling>
							<top>0</top>
							<left>0</left>
							<right>100</right>
							<bottom>100</bottom>
						</scaling>
					</objectPlacement>
					<data>
					</data>
					<columns>
						<controlInfo>
							<mouseOverCursor>Window Default</mouseOverCursor>
							<type>Text Edit</type>
							<flags>
								<invisible>false</invisible>
								<readOnly>false</readOnly>
								<mandatory>false</mandatory>
								<mandatoryLabelBackground>false</mandatoryLabelBackground>
								<mandatoryLabelText>false</mandatoryLabelText>
								<allowNullValue>false</allowNullValue>
								<skipTabStop>false</skipTabStop>
								<disabled>false</disabled>
								<protected>false</protected>
								<noMacroExpand>false</noMacroExpand>
								<readOnlyInit>false</readOnlyInit>
								<autoCompleteField>false</autoCompleteField>
								<editUnlimitedText>false</editUnlimitedText>
								<url>false</url>
								<hidden>false</hidden>
								<allowResize>true</allowResize>
								<allowSort>true</allowSort>
							</flags>
							<textLineCount>0</textLineCount>
							<textInputFormat>Text</textInputFormat>
							<properties>
								<column>catalogname</column>
							</properties>
							<name>Catalog</name>
							<width>243</width>
							<image>-1</image>
							<dataColumn>0</dataColumn>
						</controlInfo>
						<controlInfo>
							<mouseOverCursor>Window Default</mouseOverCursor>
							<type>Text Edit</type>
							<flags>
								<invisible>false</invisible>
								<readOnly>false</readOnly>
								<mandatory>false</mandatory>
								<mandatoryLabelBackground>false</mandatoryLabelBackground>
								<mandatoryLabelText>false</mandatoryLabelText>
								<allowNullValue>false</allowNullValue>
								<skipTabStop>false</skipTabStop>
								<disabled>false</disabled>
								<protected>false</protected>
								<noMacroExpand>false</noMacroExpand>
								<readOnlyInit>false</readOnlyInit>
								<autoCompleteField>false</autoCompleteField>
								<editUnlimitedText>false</editUnlimitedText>
								<url>false</url>
								<hidden>true</hidden>
								<allowResize>false</allowResize>
								<allowSort>false</allowSort>
							</flags>
							<textLineCount>0</textLineCount>
							<textInputFormat>Text</textInputFormat>
							<properties>
								<column>catalogid</column>
							</properties>
							<name>Catalogid</name>
							<width>60</width>
							<image>-1</image>
							<dataColumn>1</dataColumn>
						</controlInfo>
					</columns>
					<sortColumn>-1</sortColumn>
					<sortDescending>false</sortDescending>
					<headerHeight>18</headerHeight>
					<rowHeight>16</rowHeight>
					<selectedColor>#00008b</selectedColor>
					<selectedTextColor>#ffffff</selectedTextColor>
					<controlInfo>
						<mouseOverCursor>Window Default</mouseOverCursor>
						<properties>
							<sqlSource>swdata</sqlSource>
							<table>swkb_catalogs</table>
							<newRecordForm>Form.swkb_catalog</newRecordForm>
							<editRecordForm>Form.swkb_catalog</editRecordForm>
							<storedQuery>me.browse.table</storedQuery>
						</properties>
					</controlInfo>
				</control>
				<control>
					<general>
						<name>btnNew1</name>
						<type>EventButton</type>
					</general>
					<appearance>
						<index>1</index>
						<caption>New</caption>
						<backgroundColor>#000000</backgroundColor>
						<foregroundColor>#000000</foregroundColor>
						<font  size="8">Arial</font>
					</appearance>
					<objectPlacement>
						<position>
							<top>24</top>
							<left>272</left>
							<right>352</right>
							<bottom>48</bottom>
						</position>
						<scaling>
							<top>0</top>
							<left>100</left>
							<right>100</right>
							<bottom>0</bottom>
						</scaling>
					</objectPlacement>
					<data>
					</data>
					<controlInfo>
						<mouseOverCursor>Window Default</mouseOverCursor>
						<properties>
						</properties>
					</controlInfo>
				</control>
				<control>
					<general>
						<name>btnProperties</name>
						<type>EventButton</type>
					</general>
					<appearance>
						<index>2</index>
						<caption>Properties</caption>
						<backgroundColor>#000000</backgroundColor>
						<foregroundColor>#000000</foregroundColor>
						<font  size="8">Arial</font>
					</appearance>
					<objectPlacement>
						<position>
							<top>51</top>
							<left>272</left>
							<right>352</right>
							<bottom>75</bottom>
						</position>
						<scaling>
							<top>0</top>
							<left>100</left>
							<right>100</right>
							<bottom>0</bottom>
						</scaling>
					</objectPlacement>
					<data>
					</data>
					<controlInfo>
						<mouseOverCursor>Window Default</mouseOverCursor>
						<properties>
						</properties>
					</controlInfo>
				</control>
				<control>
					<general>
						<name>btnDelete</name>
						<type>EventButton</type>
					</general>
					<appearance>
						<index>3</index>
						<caption>Remove</caption>
						<backgroundColor>#000000</backgroundColor>
						<foregroundColor>#000000</foregroundColor>
						<font  size="8">Arial</font>
					</appearance>
					<objectPlacement>
						<position>
							<top>78</top>
							<left>272</left>
							<right>352</right>
							<bottom>102</bottom>
						</position>
						<scaling>
							<top>0</top>
							<left>100</left>
							<right>100</right>
							<bottom>0</bottom>
						</scaling>
					</objectPlacement>
					<data>
					</data>
					<controlInfo>
						<mouseOverCursor>Window Default</mouseOverCursor>
						<properties>
						</properties>
					</controlInfo>
				</control>
				<control>
					<general>
						<name>btnManage</name>
						<type>EventButton</type>
					</general>
					<appearance>
						<index>4</index>
						<caption>Manage</caption>
						<backgroundColor>#ffffff</backgroundColor>
						<foregroundColor>#000000</foregroundColor>
						<font  size="8">Arial</font>
					</appearance>
					<objectPlacement>
						<position>
							<top>118</top>
							<left>272</left>
							<right>352</right>
							<bottom>142</bottom>
						</position>
						<scaling>
							<top>0</top>
							<left>100</left>
							<right>100</right>
							<bottom>0</bottom>
						</scaling>
					</objectPlacement>
					<data>
					</data>
					<controlInfo>
						<mouseOverCursor>Window Default</mouseOverCursor>
						<properties>
							<backgroundColor>#ff9900</backgroundColor>
						</properties>
					</controlInfo>
				</control>
				<control>
					<general>
						<name>btnClose</name>
						<type>EventButton</type>
					</general>
					<appearance>
						<index>5</index>
						<caption>Close</caption>
						<backgroundColor>#000000</backgroundColor>
						<foregroundColor>#000000</foregroundColor>
						<font  size="8">Arial</font>
					</appearance>
					<objectPlacement>
						<position>
							<top>163</top>
							<left>272</left>
							<right>352</right>
							<bottom>187</bottom>
						</position>
						<scaling>
							<top>100</top>
							<left>100</left>
							<right>100</right>
							<bottom>100</bottom>
						</scaling>
					</objectPlacement>
					<data>
					</data>
					<controlInfo>
						<mouseOverCursor>Window Default</mouseOverCursor>
						<properties>
						</properties>
					</controlInfo>
				</control>
			</controls>
			<formActions>
			</formActions>
			<javascript>
				<methods>
					<method>
						<name>btnProperties_OnPressed</name>
						<code>
							<![CDATA[btnProperties_OnPressed()
{
    SqlList1.EditRecord(SqlList1.curSel);
}
]]>
						</code>
					</method>
					<method>
						<name>btnDelete_OnPressed</name>
						<code>
							<![CDATA[btnDelete_OnPressed()
{
    //-- nwj :- use key col name instead of numbering
    var sCol = dd.tables[SqlList1.table].PrimaryKey;
   
    if(sCol=="")
    {
            MessageBox("No primary key is defined for this table. Please contact your Supportworks Administrator");
    }
    else
    {
            if(SqlList1.curSel != -1)
            {
            
            		var strKeyValue = SqlList1.GetItemTextRaw(SqlList1.curSel, sCol);
     
             		//-- nwj - we are not allowed to delete catalogs 1,2 or 3
                    if(strKeyValue=="1" || strKeyValue=="2" || strKeyValue=="3")
                    {
                    	MessageBox("The selected catalog is a system catalog and cannot be deleted.");
                    	return true;
                    }

					// F0104634
					var intCount = app.g.sqs_rowcount("count/articles_in_catalog", 'catalog='+strKeyValue);
					if(intCount>0)
					{
						MessageBox('There is '+intCount+' article(s) still in this catalog, please reassign these before deleting the catalog.');
						return false;
					}

					

                    //--  ask them to confirm
                    if(!confirm('Are you sure you want to delete the selected record?'))return false;
                    //-- nwj :- determine if needs quotes
                    var strQ = (dd.tables[SqlList1.table].columns[sCol].IsNumeric())?"":"'";
                    
                   
                 
                    if(strKeyValue != "")
                    {
                            if(app.g.sqlexecute_delete(SqlList1.table, strKeyValue))
                            {
                                    // This next call removes the row from the list, not the database
                                    SqlList1.RemoveRow(SqlList1.curSel);
                            }
                            
                            //F0104625
                            app.g.submitsqs("knowledgebase/clean_kb_catalog_rights.delete", "catalogid="+strKeyValue);
                     }
            }
    }
}]]>
						</code>
					</method>
					<method>
						<name>btnClose_OnPressed</name>
						<code>
							<![CDATA[btnClose_OnPressed()
{
    _swdoc.CloseForm();
}
]]>
						</code>
					</method>
					<method>
						<name>btnNew1_OnPressed</name>
						<code>
							<![CDATA[btnNew1_OnPressed()
{
    app.OpenFormForAdd("swkb_catalog", "", "", true, function(){
    	SqlList1.Refresh();
    });
}]]>
						</code>
					</method>
					<method>
						<name>OnFormLoaded</name>
						<code>
							<![CDATA[OnFormLoaded(bDataReloaded)
{
	//-- check catalog list against sys catalog list
	var array_system_catalogs = new Array();	
	
	var xmlmc = new XmlMethodCall;
	if(xmlmc.Invoke("knowledgebase", "catalogList"))
	{
	   	//-- get the result
		var strXML = (app.bWebClient)? xmlmc._lastresult:xmlmc.GetReturnXml();
		var objRes = app.XMCResult(strXML);
		if(!objRes.success)
		{
	        MessageBox("Failed to load catalogs (" + objRes.message + "). Please contact your Supportworks Supervisor.");
	    }	
	    else
	    {
	    	//-- create xmldom from returned xml
	    	var array_system_catalogs = new Array();
			var myXmlFile = new XmlFile(); 
			bRet = myXmlFile.loadFromString(strXML); 

			var strItems = "";
			oRec = new Object();
			for (count = 1; count < myXmlFile.methodCallResult.data.length; count ++) 
			{  
				var strCatId = myXmlFile.methodCallResult.data[count]['catalogId'].nodeValue;
				var strName = myXmlFile.methodCallResult.data[count]['name'].nodeValue;
				array_system_catalogs[strCatId] = strName;	
			}
	    }
    }
    else
    {
    	MessageBox("Failed to invoke knowledgebase.catalogList. " + xmlmc.GetLastError() + ". Please contact your Supportworks Supervisor.");
    }	


	//-- check against sqllist - if any missing then create
	for(intCataLogID in	array_system_catalogs)
	{
		if(app.g.sl_findrow_byvalue(SqlList1,intCataLogID,"catalogid")==-1)
		{
			var oInsert = new app.oXmlmcInsert('swkb_catalogs');
			oInsert.setfield('catalogid',intCataLogID);
			oInsert.setfield('catalogname',array_system_catalogs[intCataLogID]);
			oInsert.execute();
		}
	}	
	
	SqlList1.Refresh();

}]]>
						</code>
					</method>
					<method>
						<name>btnManage_OnPressed</name>
						<code>
							<![CDATA[btnManage_OnPressed()
{
	app.g.search_for("swkb", false, "searchmode=0");

}]]>
						</code>
					</method>
				</methods>
			</javascript>
		</layout>
		<layout>
			<appearance>
				<width>360</width>
				<height>220</height>
				<backgroundColor>#ffffff</backgroundColor>
				<fillColour>#ffffff</fillColour>
				<textColour >#000000</textColour >
				<font  size="8">Arial</font>
			</appearance>
			<controls>
			</controls>
			<formActions>
			</formActions>
			<javascript>
				<methods>
				</methods>
			</javascript>
		</layout>
	</layouts>
</espForm>
