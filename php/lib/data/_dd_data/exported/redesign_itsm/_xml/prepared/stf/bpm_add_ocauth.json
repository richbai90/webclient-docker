{"espForm":{"configuration":{"settings":{"name":"bpm_add_ocauth","title":"Stage Authoriser","options":{"allowResize":"true","showMenubar":"false","showToolbar":"true","showStatusBar":"false"}},"tables":{"table":{"name":"bpm_oc_auth","type":"Main Details Table","flags":"2"}},"javascript":{"methods":{"method":[{"name":"(Globals)","code":"var strManager = \"\";\n\nfunction oAuth()\n{\n\treturn _swdoc.bpm_oc_auth;\n}\n\nfunction MF()\n{\n\treturn _swdoc.mainform;\n}"},{"name":"OnDataSaved","code":"OnDataSaved()\n{\n\t\/\/-- send notification to authoriser (if analsyt)\n\tif (_swdoc.oAuth().authortype==\"Analyst\")\n\t{\n\t\tvar strCallref = app.g.callref_pad(_swdoc.GetArg('fk_callref'));\n\t\tvar xmlmc = new XmlMethodCall;\n\t\n\t\t\/\/ Set up our input parameters\n\t\txmlmc.SetValue(\"in_to\", _swdoc.oAuth().fk_auth_id);\n\t\txmlmc.SetValue(\"in_subject\", \"Request Authorisation Required For \" + strCallref);\n\t\txmlmc.SetValue(\"in_text\", \"The request \" + strCallref + \" requires your authorisation. Please process according to your business rules\");\n\t\n\t\t\/\/ Invoke the method\n\t\tif(xmlmc.Invoke(\"VPME\", \"genericSendSwNotification\"))\n\t\t{\n\t\t\t\n\t\t}\n\t\telse\n\t\t{\n\t\t\tMessageBox(xmlmc.GetLastError());\n\t\t}\n\t}\n\t\n\tvar xmlmc = new XmlMethodCall;\n\n\t\/\/ Set up our input parameters\n\txmlmc.SetValue(\"callref\", _swdoc.GetArg('fk_callref'));\n\txmlmc.SetValue(\"authid\", _swdoc.oAuth().fk_auth_id);\n\txmlmc.SetValue(\"bpm_stage_id\", _swdoc.GetArg('fk_stage_id'));\n\txmlmc.SetValue(\"authtype\", _swdoc.oAuth().authortype);\n\n\t\/\/ Invoke the method\n\tif(xmlmc.Invoke(\"VPME\", \"bpmEmailOnFlyAuthoriser\"))\n\t{\n\t\t\n\t}\n\telse\n\t{\n\t\tMessageBox(xmlmc.GetLastError());\n\t}\n\n\t\/\/-- update call to show that waiting auth\n\tapp.g.update_callvalue(_swdoc.GetArg('fk_callref'),\"1\",\"bpm_waitingauth\",true);\n\n\n}"}]}}},"layouts":{"layout":[{"appearance":{"width":"371","height":"105","backgroundColor":"#ffffff","fillColour":"#ffffff","textColour":"#000000","font":{"@size":"8","#text":"Arial"}},"controls":{"control":[{"general":{"type":"FieldName","flags":{"transparent":"true","xpStyle":"false","hasShadow":"false","toolbarButtonStyle":"false","cache":"false","hasBorder":"false","hasCheckbox":"false"}},"appearance":{"index":"0","caption":"Authoriser","backgroundColor":"#ffffff","foregroundColor":"#000000","font":{"@size":"8","#text":"Arial"},"alignment":"Right","borderStyle":"None","fillStyle":"Solid"},"objectPlacement":{"position":{"top":"50","left":"16","right":"126","bottom":"68"},"scaling":{"top":"0","left":"0","right":"0","bottom":"0"}},"data":{"binding":"bpm_oc_auth.fk_auth_id"},"controlInfo":{"mouseOverCursor":"Window Default"}},{"general":{"type":"Field"},"appearance":{"index":"1","backgroundColor":"#ffffff","foregroundColor":"#000000","font":{"@size":"8","#text":"Arial"},"borderStyle":"Rectangle"},"objectPlacement":{"position":{"top":"50","left":"130","right":"342","bottom":"68"},"scaling":{"top":"0","left":"0","right":"100","bottom":"0"}},"data":{"binding":"bpm_oc_auth.fk_auth_id"},"controlInfo":{"mouseOverCursor":"Window Default","type":"Text Edit","flags":{"invisible":"false","readOnly":"true","mandatory":"true","mandatoryLabelBackground":"false","mandatoryLabelText":"false","allowNullValue":"false","skipTabStop":"false","disabled":"true","protected":"false","noMacroExpand":"false","readOnlyInit":"false","autoCompleteField":"false","editUnlimitedText":"false","url":"false"},"textLineCount":"0","textInputFormat":"Text","properties":{"disabledBackgroundColor":"#eeeeee","borderColor":"#c0c0c0"}}},{"general":{"type":"FieldName","flags":{"transparent":"true","xpStyle":"false","hasShadow":"false","toolbarButtonStyle":"false","cache":"false","hasBorder":"false","hasCheckbox":"false"}},"appearance":{"index":"2","caption":"Authoriser Type","backgroundColor":"#ffffff","foregroundColor":"#000000","font":{"@size":"8","#text":"Arial"},"alignment":"Right","borderStyle":"None","fillStyle":"Solid"},"objectPlacement":{"position":{"top":"28","left":"16","right":"126","bottom":"46"},"scaling":{"top":"0","left":"0","right":"0","bottom":"0"}},"data":{"binding":"bpm_oc_auth.authortype"},"controlInfo":{"mouseOverCursor":"Window Default"}},{"general":{"name":"fld_authtype","type":"Field"},"appearance":{"index":"3","backgroundColor":"#ffffff","foregroundColor":"#000000","font":{"@size":"8","#text":"Arial"},"borderStyle":"Rectangle"},"objectPlacement":{"position":{"top":"28","left":"130","right":"342","bottom":"46"},"scaling":{"top":"0","left":"0","right":"100","bottom":"0"}},"data":{"binding":"bpm_oc_auth.authortype"},"controlInfo":{"mouseOverCursor":"Window Default","type":"Pick List","flags":{"invisible":"false","readOnly":"false","mandatory":"true","mandatoryLabelBackground":"false","mandatoryLabelText":"false","allowNullValue":"false","skipTabStop":"false","disabled":"false","protected":"false","noMacroExpand":"false","readOnlyInit":"false","comboAutoUpdate":"false","comboNewValues":"true","useDDPickList":"false"},"textLineCount":"0","textInputFormat":"Text","properties":{"disabledBackgroundColor":"#eeeeee","defaultValue":"Analyst","listItems":"Analyst|Customer|","borderColor":"#c0c0c0"}}},{"general":{"name":"btn_search","type":"EventButton","flags":{"transparent":"false","xpStyle":"true","hasShadow":"false","toolbarButtonStyle":"false","cache":"false","hasBorder":"false","hasCheckbox":"false"}},"appearance":{"index":"4","caption":"...","backgroundColor":"#ffffff","foregroundColor":"#000000","font":{"@size":"8","#text":"Arial"}},"objectPlacement":{"position":{"top":"48","left":"324","right":"342","bottom":"68"},"scaling":{"top":"0","left":"100","right":"100","bottom":"0"}},"controlInfo":{"mouseOverCursor":"Window Default"}},{"general":{"name":"Label1","type":"FieldName","flags":{"transparent":"true","xpStyle":"false","hasShadow":"false","toolbarButtonStyle":"false","cache":"false","hasBorder":"false","hasCheckbox":"false"}},"appearance":{"index":"5","caption":"Weighting","backgroundColor":"#ffffff","foregroundColor":"#000000","font":{"@size":"8","#text":"Arial"},"alignment":"Right","borderStyle":"None","fillStyle":"Solid"},"objectPlacement":{"position":{"top":"73","left":"71","right":"126","bottom":"89"},"scaling":{"top":"0","left":"0","right":"0","bottom":"0"}},"data":{"binding":"bpm_oc_auth.weighting"},"controlInfo":{"mouseOverCursor":"Window Default","properties":{"controlGroup":"authWeighting"}}},{"general":{"name":"fld_weighting","type":"Field"},"appearance":{"index":"6","backgroundColor":"#ffffff","foregroundColor":"#000000","font":{"@size":"8","#text":"Arial"},"borderStyle":"Rectangle"},"objectPlacement":{"position":{"top":"72","left":"130","right":"342","bottom":"90"},"scaling":{"top":"0","left":"0","right":"100","bottom":"0"}},"data":{"binding":"bpm_oc_auth.weighting"},"controlInfo":{"mouseOverCursor":"Window Default","type":"Text Edit","flags":{"invisible":"false","readOnly":"false","mandatory":"true","mandatoryLabelBackground":"false","mandatoryLabelText":"false","allowNullValue":"false","skipTabStop":"false","disabled":"false","protected":"false","noMacroExpand":"false","readOnlyInit":"false","autoCompleteField":"false","editUnlimitedText":"false","url":"false"},"textLineCount":"0","textInputFormat":"Numeric","properties":{"defaultValue":"50","image":"#eeeeee","borderColor":"#c0c0c0","disabledBackgroundColor":"#eeeeee","controlGroup":"authWeighting"}}}]},"javascript":{"methods":{"method":[{"name":"btn_search_OnPressed","code":"btn_search_OnPressed()\n{\n\tswitch(_swdoc.oAuth().authortype)\n\t{\n\t\tcase \"Analyst\":\n\t\t\t\/\/-- get analyst\n\t\t\tapp.g.pick_analyst(\"Select an Authoriser\", function(oAnalyst)\n\t\t\t{\n\t\t\t\tif\t(oAnalyst)\n\t\t\t\t{\n\t\t\t\t\t_swdoc.oAuth().fk_auth_id=oAnalyst.id;\n\t\t\t\t\t_swdoc.oAuth().authorname=oAnalyst.name;\n\t\t\t\t\t_swdoc.UpdateFormFromData();\n\t\t\t\t}\n\t\t\t});\n\t\t\tbreak;\n\t\tcase \"Customer\":\n\t\t\t\/\/-- get customer\n\t\t\tapp.g.search_for(\"customers\", false, \"\", function(oRes)\n\t\t\t{\n\t\t\t\tif(oRes)\n\t\t\t\t{\n\t\t\t\t\tarrKeys = oRes.selectedkeys.split(\",\");\n\t\t\t\t\tarrNames = oRes.selectedother.split(\",\");\n\t\t\t\t\t_swdoc.oAuth().fk_auth_id=arrKeys[0];\n\t\t\t\t\t_swdoc.oAuth().authorname=arrNames[0];\n\t\t\t\t\t_swdoc.UpdateFormFromData();\n\t\t\t\t}\n\t\t\t});\n\t\t\tbreak;\t\n\t\tcase \"Licensed Approver\":\n\t\t\t\/\/-- get customer\n\t\t\tapp.g.popup(\"TbLicensedApprover\", \"s=1\",function(oRes){\n\t\t\t\tif(oRes)\n\t\t\t\t{\n\t\t\t\t\tif (\"\"!=oRes.document.selectedkey){\n\t\t\t\t\t\t_swdoc.oAuth().fk_auth_id=oRes.document.selectedkey;\n\t\t\t\t\t\t_swdoc.oAuth().authorname=oRes.document.selectedfirstname + \" \" + oRes.document.selectedsurname;\n\t\t\t\t\t\tif (\" \" == _swdoc.oAuth().authorname) _swdoc.oAuth().authorname = oRes.document.selectedkey;\n\t\t\t\t\t\t\t\t_swdoc.UpdateFormFromData();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\t\t\t\n\t\t\tbreak;\t\t\t\t\n\t}\n}"},{"name":"OnFormLoaded","code":"OnFormLoaded()\n{\n\t\/\/-- pop defaults\n\tif(_swdoc.oAuth().pk_auth_id<1)\n\t{\n\t\t_swdoc.oAuth().flg_status= \"0\";\n\t\t_swdoc.oAuth().flg_isonfly= 1;\n\t\t\n\t\t_swdoc.oAuth().status= \"Pending authorisation\";\n\t\tapp.g.popuplate_form_fromargs(\"bpm_oc_auth\", _swdoc, false, true);\n\t}\n\t\n\tvar authWeighting = _swdoc.GetArg(\"unanimous\");\n\tif(authWeighting==1)\n\t{\n\t\tapp._evi(_swdoc.MF().authWeighting, false);\n\t}\n\t\n\tvar strPickList = \"Analyst|Customer\";\n\t_swdoc.strManager = _swdoc.GetArg(\"fk_manager\");\n\tif(_swdoc.strManager!=\"\")\n\t{\n\t\tstrPickList += \"|Customer's Manager\";\n\t}\n\t\n\tvar h = app.g.submit_php(\"php\/itsm\/license_check.php\", false);\n\tvar t = h.indexOf(\"licenses_in_use\");\n\tvar licensed_for = h.substring(0,t);\n\tvar lf = parseInt(licensed_for.replace(\/\\D\/g,\"\"));\n\tif(lf>0)\n\t{\n\t\tstrPickList += \"|Licensed Approver\";\n\t}\n\tmainform.fld_authtype.pickList = strPickList;\n\n}"},{"name":"fld_authtype_OnValueChanged","code":"fld_authtype_OnValueChanged(strValue)\n{\n\t\/\/ TODO: Add your event handler code here\n\tif(strValue==\"Customer's Manager\")\n\t{\n\t\t_swdoc.oAuth().fk_auth_id=_swdoc.strManager;\n\t\tvar oManager = app.g.get_record(\"userdb\", _swdoc.oAuth().fk_auth_id);\n\t\t_swdoc.oAuth().authorname=oManager.fullname;\n\t\tapp._een(mainform.btn_search,false);\t\n\t}\n\telse\n\t{\n\t\t_swdoc.oAuth().fk_auth_id=\"\";\n\t\t_swdoc.oAuth().authorname=\"\";\t\n\t\tapp._een(mainform.btn_search,true);\t\n\t}\n\t_swdoc.UpdateFormFromData();\n\n}"}]}}},{"appearance":{"width":"360","height":"220","backgroundColor":"#ffffff","fillColour":"#ffffff","textColour":"#000000","font":{"@size":"8","#text":"Arial"}},"javascript":{}}]}}}